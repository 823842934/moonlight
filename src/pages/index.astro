---
import FrameLayout from "../layouts/FrameLayout.astro";
---

<FrameLayout title="Body of Work">
  <section class="hero">
    <div class="stack" id="stack">
      <h1 id="logo">brandyura</h1>

      <div class="tree" id="tree" aria-label="gallery tree">
        <div class="tree-viewport" id="viewport">
          <!-- GALLERY VIEW -->
          <div id="galleryView" class="view view--active">
            <div class="root gallery-line">Gallery</div>

            <div class="children">
              <button class="item item-btn gallery-line" type="button" data-study="study:[//000-00001]">└─ Study:[<span class="glyph-slot glyph-animated">//</span>000-00001]</button>
            </div>

            <div class="root gallery-line">About</div>
            <div class="children">
              <button class="item item-btn gallery-line" type="button" data-node="biography">├─ Biography</button>
              <button class="item item-btn gallery-line" type="button" data-node="statement">├─ Statement</button>
              <button class="item item-btn gallery-line" type="button" data-node="process">└─ Process</button>
            </div>

            <div class="root gallery-line">Contact</div>
            <div class="children">
              <button class="item item-btn gallery-line" type="button" data-node="social">└─ Social</button>
            </div>

            <div class="root gallery-line">Legal</div>
            <div class="children">
              <button class="item item-btn gallery-line" type="button" data-node="info">└─ Info</button>
            </div>
          </div>

          <!-- STUDY VIEW -->
          <div id="studyView" class="view zoomed">
            <button id="backBtn" class="back" type="button">
              <span class="arrow">←</span><span class="label"> Back</span>
            </button>

            <div id="studyRoot" class="root">
              └─ Study:[<span id="studyGlyph" class="glyph-slot">//</span><span id="studyId">000-00001</span>]
            </div>

            <div class="children children--indented">
              <div class="item cascade" data-cascade="1">├─ About</div>
              <div class="item cascade" data-cascade="2">├─ Purpose</div>
              <div class="item cascade" data-cascade="3">└─ Date</div>
            </div>
          </div>

          <!-- NODE VIEW -->
          <div id="nodeView" class="view zoomed">
            <button id="nodeBackBtn" class="back" type="button">
              <span class="arrow">←</span><span class="label"> Back</span>
            </button>

            <div id="nodeRoot" class="root" data-cascade="0"></div>
            <div class="children children--indented" id="nodeChildren"></div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <style>
    /* ===== MOBILE HORIZONTAL SCROLL FIX (GLOBAL FOR THIS PAGE) ===== */
    html, body {
      max-width: 100%;
      overflow: hidden !important;
      overscroll-behavior-x: none;
      scrollbar-width: none !important;
      -ms-overflow-style: none !important;
    }

    html::-webkit-scrollbar,
    body::-webkit-scrollbar {
      display: none !important;
      width: 0 !important;
      height: 0 !important;
    }

    * {
      box-sizing: border-box;
      max-width: 100%;
      scrollbar-width: none !important;
      -ms-overflow-style: none !important;
    }

    *::-webkit-scrollbar {
      display: none !important;
      width: 0 !important;
      height: 0 !important;
    }

    .hero {
      min-height: 100dvh;
      padding-left: 5vw;
      padding-right: 5vw;
      padding-top: clamp(60px, 8vh, 100px);
      padding-bottom: clamp(16px, 4vh, calc(var(--corner-inset, 22px) + var(--corner-size, 28px)));
      display: flex;
      justify-content: center;
      align-items: flex-start;
      overflow-x: hidden;
    }

    .stack {
      width: min(1100px, 100%);
      box-sizing: border-box;
      padding-top: 2px;
    }

    h1 {
      font-family: "ABC Diatype", system-ui, sans-serif;
      font-weight: 700;
      font-size: clamp(56px, 16vw, 260px);
      letter-spacing: -0.05em;
      line-height: 1;
      margin: 0;
      width: 100%;
      text-align: center;
      text-rendering: geometricPrecision;
      position: fixed;
      top: clamp(60px, 8vh, 100px);
      left: 50%;
      transform: translateX(-50%);
      z-index: 10;
      pointer-events: none;
    }

    .logo-blur { filter: blur(6px); }

    #logo {
      transition:
        opacity 260ms cubic-bezier(.22,.61,.36,1),
        filter 260ms cubic-bezier(.22,.61,.36,1);
      will-change: opacity, filter;
    }
    body.study-triggered #logo {
      opacity: 0;
      filter: blur(10px);
    }

    .tree {
      margin-top: calc(clamp(56px, 16vw, 260px) + clamp(3rem, 6vh, 4rem));
      font-family: "ABC Diatype", system-ui, sans-serif;
      font-size: clamp(14px, 3.5vw, 18px);
      letter-spacing: 0.02em;
      width: 100%;
      box-sizing: border-box;
      position: relative;
      z-index: 5;
    }

    .tree-viewport {
      position: relative;
      min-height: 12.5rem;
      width: 100%;
      max-width: 100%;
      overflow: visible;
    }

    .root,
    .item,
    .item-btn,
    .back {
      white-space: nowrap;
      overflow-wrap: normal;
      word-break: normal;
      hyphens: none;
    }

    .root { margin: 0; }

    .children {
      margin-top: 0.35rem;
      display: grid;
      gap: 0.18rem;
      width: fit-content;
      margin-bottom: 0.55rem;
    }

    .children--indented {
      padding-left: 2ch;
      margin-bottom: 0;
    }

    .item {
      line-height: 1.25;
      width: fit-content;
    }

    .item-btn {
      background: none;
      border: 0;
      padding: 0;
      font: inherit;
      color: inherit;
      cursor: pointer;
      text-align: left;
      display: inline-block;
      width: fit-content;
    }

    .back {
      background: none;
      border: 0;
      padding: 0;
      font: inherit;
      color: inherit;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.15em;
      margin-bottom: 0.35rem;
      transition: transform 80ms ease, opacity 80ms ease;
    }

    @keyframes itemFlash {
      0% { 
        transform: scale(1);
        filter: brightness(1);
      }
      50% {
        transform: scale(1.05);
        filter: brightness(2);
      }
      100% { 
        transform: scale(1);
        filter: brightness(1);
      }
    }

    @keyframes backFlash {
      0% { 
        transform: scale(1);
        filter: brightness(1);
        opacity: 1;
      }
      30% {
        transform: scale(1.05);
        filter: brightness(2);
        opacity: 1;
      }
      100% { 
        transform: scale(1);
        filter: brightness(1);
        opacity: 0;
      }
    }

    .back.flash {
      animation: backFlash 300ms ease-out forwards;
    }

    .item-btn.flash {
      animation: itemFlash 200ms ease-out !important;
      animation-fill-mode: forwards;
    }

    .view {
      position: absolute;
      inset: 0;
      width: 100%;
      max-width: 100%;
      transition: opacity 260ms ease;
    }

    .view:not(.view--active) {
      opacity: 0;
      pointer-events: none;
    }

    .view.view--active { opacity: 1; }

    .zoomed { 
      font-size: clamp(18px, 4.5vw, 26px);
    }

    .zoomed.zoom-animate {
      animation: textZoomIn 400ms cubic-bezier(.22,.61,.36,1) forwards;
    }

    @keyframes textZoomIn {
      0% {
        font-size: clamp(14px, 3.5vw, 18px);
      }
      100% {
        font-size: clamp(18px, 4.5vw, 26px);
      }
    }

    .cascade {
      opacity: 0;
      transform: translateX(16px);
      transition: opacity 260ms ease, transform 260ms ease;
    }
    .view--active .cascade {
      opacity: 1;
      transform: translateX(0);
    }
    .view--active .cascade[data-cascade="0"] { transition-delay: 0ms; }
    .view--active .cascade[data-cascade="1"] { transition-delay: 80ms; }
    .view--active .cascade[data-cascade="2"] { transition-delay: 160ms; }
    .view--active .cascade[data-cascade="3"] { transition-delay: 240ms; }

    .glyph-slot {
      display: inline-block;
      width: 2ch;
      text-align: center;
    }

    @keyframes galleryIntroCascade {
      from { opacity: 0; transform: translateY(-10px); filter: blur(1px); }
      to   { opacity: 1; transform: translateY(0);   filter: blur(0); }
    }

    .gallery-line { 
      opacity: 1;
      transition: opacity 600ms ease, filter 600ms ease;
    }

    body.gallery-intro-cascade .gallery-line {
      opacity: 0;
      animation: galleryIntroCascade 420ms cubic-bezier(.25,.8,.25,1) forwards;
    }

    /* Thanos snap effect - pure CSS */
    .gallery-line.dust-out {
      animation: dustDissolve 600ms ease-out forwards;
    }

    .root.dust-out,
    .children.dust-out,
    .item.dust-out {
      animation: dustDissolve 600ms ease-out forwards;
    }

    @keyframes dustDissolve {
      0% {
        opacity: 1;
        filter: blur(0px);
      }
      50% {
        opacity: 0.5;
        filter: blur(2px);
      }
      100% {
        opacity: 0;
        filter: blur(4px);
      }
    }

    @keyframes instantSlideUp {
      0% {
        opacity: 1;
        transform: translateY(0);
      }
      100% {
        opacity: 0;
        transform: translateY(-20px);
      }
    }

    @media (prefers-reduced-motion: reduce) {
      body.gallery-intro-cascade .gallery-line {
        opacity: 1;
        animation: none !important;
        transform: none !important;
        filter: none !important;
      }
      #logo { transition: none !important; }
      .tree-viewport { transition: none !important; }
      .view { transition: none !important; }
      .gallery-line { transition: none !important; }
      .gallery-line.dust-out { animation: none !important; }
    }

    @media (max-width: 520px) {
      html, body {
        overflow-x: hidden;
        touch-action: pan-y;
      }

      body {
        position: relative;
      }

      .hero {
        padding-top: calc(22px + env(safe-area-inset-top, 0px));
        padding-bottom: 16px;
      }
    }
  </style>

  <script>
    // =========================================================================
    // CONFIGURATION
    // =========================================================================
    const TIMINGS = {
      DUST_EFFECT_DELAY: 260,
      BACK_FADE_OUT: 260,
      GALLERY_FADE_IN: 200,
      GLYPH_INTERVAL: 110,
    };

    const GLYPHS = ["//", "--", "\\\\", "| |"];
    const STUDY_REGEX = /^study:\[(\/\/|--|\\\\|\|\s\|)([0-9]{3}-[0-9]{5})\]$/i;

    // =========================================================================
    // DOM ELEMENTS
    // =========================================================================
    const stack = document.getElementById("stack");
    const logo = document.getElementById("logo");
    const viewport = document.getElementById("viewport");
    const galleryView = document.getElementById("galleryView");
    const studyView = document.getElementById("studyView");
    const nodeView = document.getElementById("nodeView");
    const studyRoot = document.getElementById("studyRoot");
    const studyGlyph = document.getElementById("studyGlyph");
    const studyId = document.getElementById("studyId");
    const nodeRoot = document.getElementById("nodeRoot");
    const nodeChildren = document.getElementById("nodeChildren");
    const backBtn = document.getElementById("backBtn");
    const nodeBackBtn = document.getElementById("nodeBackBtn");
    const studyButtons = document.querySelectorAll("[data-study]");
    const nodeButtons = document.querySelectorAll("[data-node]");

    const prefersReducedMotion = window.matchMedia("(prefers-reduced-motion: reduce)");

    // Animation lock to prevent spam clicking
    let isAnimating = false;

    // =========================================================================
    // PLACEHOLDER FUNCTIONS (preserved for future use)
    // =========================================================================
    function centerLogoAcrossDevices() {}
    function syncTreeToLogo() {}
    let lastOrigin = null;
    function applyZoomOriginFromEl(el) {}
    function clearZoomOriginAfterOut() {}

    // =========================================================================
    // GLYPH ANIMATION
    // =========================================================================
    const GlyphAnimator = {
      studyTimer: null,
      studyIndex: 0,
      galleryTimer: null,
      galleryIndex: 0,

      startStudyLoop() {
        if (this.studyTimer) return;
        this.studyIndex = 0;
        studyGlyph.textContent = GLYPHS[0];

        this.studyTimer = setInterval(() => {
          this.studyIndex = (this.studyIndex + 1) % GLYPHS.length;
          studyGlyph.textContent = GLYPHS[this.studyIndex];
        }, TIMINGS.GLYPH_INTERVAL);
      },

      stopStudyLoop() {
        if (this.studyTimer) {
          clearInterval(this.studyTimer);
          this.studyTimer = null;
        }
        this.studyIndex = 0;
        studyGlyph.textContent = GLYPHS[0];
      },

      startGalleryLoop() {
        if (this.galleryTimer) return;

        const glyphElements = document.querySelectorAll('.glyph-animated');
        if (!glyphElements.length) return;

        this.galleryIndex = 0;

        this.galleryTimer = setInterval(() => {
          this.galleryIndex = (this.galleryIndex + 1) % GLYPHS.length;
          glyphElements.forEach(el => {
            el.textContent = GLYPHS[this.galleryIndex];
          });
        }, TIMINGS.GLYPH_INTERVAL);
      },

      stopGalleryLoop() {
        if (this.galleryTimer) {
          clearInterval(this.galleryTimer);
          this.galleryTimer = null;
        }
        document.querySelectorAll('.glyph-animated').forEach(el => {
          el.textContent = GLYPHS[0];
        });
        this.galleryIndex = 0;
      },
    };

    // =========================================================================
    // GALLERY INTRO CASCADE
    // =========================================================================
    const IntroCascade = {
      hasRun: false,

      run() {
        if (this.hasRun) return;
        this.hasRun = true;

        const lines = Array.from(document.querySelectorAll("#galleryView .gallery-line"));
        if (!lines.length) return;

        document.body.classList.add("gallery-intro-cascade");

        const stagger = 80;
        const duration = 420;

        requestAnimationFrame(() => {
          lines.forEach((el, i) => {
            el.style.animationDelay = `${i * stagger}ms`;
          });
        });

        const total = duration + (lines.length - 1) * stagger + 60;

        setTimeout(() => {
          document.body.classList.remove("gallery-intro-cascade");
          requestAnimationFrame(() => {
            lines.forEach(el => {
              el.style.animationDelay = "";
              el.style.opacity = "";
              el.style.transform = "";
              el.style.filter = "";
              el.style.animation = "";
            });
          });
        }, total);
      },
    };

    // =========================================================================
    // UTILITIES
    // =========================================================================
    function parseStudy(str) {
      const match = String(str || "").match(STUDY_REGEX);
      return match ? { glyph: match[1], id: match[2] } : null;
    }

    // =========================================================================
    // CASCADE ANIMATION
    // =========================================================================
    function playCascade(containerEl) {
      if (!containerEl || prefersReducedMotion.matches) return;

      const elements = Array.from(containerEl.querySelectorAll("[data-cascade]"))
        .filter(el => el instanceof HTMLElement)
        .sort((a, b) => (Number(a.dataset.cascade) || 0) - (Number(b.dataset.cascade) || 0));

      if (!elements.length) return;

      requestAnimationFrame(() => {
        elements.forEach(el => {
          const n = Number(el.dataset.cascade) || 0;
          el.style.cssText = `
            transition-property: opacity, transform;
            transition-duration: 260ms;
            transition-timing-function: ease;
            transition-delay: ${n * 80}ms;
            opacity: 0;
            transform: translateX(16px);
          `;
        });

        void containerEl.offsetWidth;

        requestAnimationFrame(() => {
          elements.forEach(el => {
            el.style.opacity = "1";
            el.style.transform = "translateX(0)";
          });
        });
      });
    }

    // =========================================================================
    // DUST EFFECT
    // =========================================================================
    const DustEffect = {
      trigger(excludeElement) {
        if (prefersReducedMotion.matches) return;

        document.querySelectorAll('#galleryView .gallery-line').forEach(line => {
          line.classList.add('dust-out');

          if (line === excludeElement || line.contains(excludeElement)) {
            line.style.opacity = "0";
            line.style.transition = "opacity 100ms ease";
          }
        });
      },

      clear() {
        document.querySelectorAll('#galleryView .gallery-line').forEach(line => {
          line.classList.remove('dust-out');
          line.style.opacity = "";
          line.style.filter = "";
          line.style.transition = "";
        });
      },
    };

    // =========================================================================
    // VIEW TRANSITIONS
    // =========================================================================
    function transitionToView(targetView, clickedElement, setupCallback) {
      if (isAnimating) return;
      isAnimating = true;

      document.body.classList.add("study-triggered");
      DustEffect.trigger(clickedElement);

      setTimeout(() => {
        GlyphAnimator.stopGalleryLoop();

        requestAnimationFrame(() => {
          galleryView.classList.remove("view--active");
          studyView.classList.remove("view--active");
          nodeView.classList.remove("view--active");

          studyView.classList.remove("zoom-animate");
          nodeView.classList.remove("zoom-animate");

          // Clear dust-out from the target view before showing it
          targetView.querySelectorAll('.root, .children, .item').forEach(el => {
            el.classList.remove('dust-out');
          });

          // Clear flash class from back buttons
          targetView.querySelectorAll('.back').forEach(btn => {
            btn.classList.remove('flash');
          });

          targetView.classList.add("view--active");
          logo.classList.add("logo-blur");

          void targetView.offsetWidth;
          targetView.classList.add("zoom-animate");

          if (setupCallback) setupCallback();
          
          // Unlock after animation completes
          setTimeout(() => {
            isAnimating = false;
          }, 400);
        });
      }, TIMINGS.DUST_EFFECT_DELAY);
    }

    function clearStudyInlineAnim() {
      const studyLines = Array.from(document.querySelectorAll('#galleryView [data-study].gallery-line'));
      requestAnimationFrame(() => {
        studyLines.forEach(el => {
          el.style.cssText = "";
        });
      });
    }

    // =========================================================================
    // VIEW NAVIGATION
    // =========================================================================
    function showStudy(name, clickedElement) {
      const parsed = parseStudy(name);

      if (parsed) {
        studyGlyph.textContent = GLYPHS[0];
        studyId.textContent = parsed.id;
      } else {
        studyRoot.textContent = `└─ ${name}`;
      }

      transitionToView(studyView, clickedElement, () => {
        requestAnimationFrame(() => requestAnimationFrame(() => {
          GlyphAnimator.startStudyLoop();
        }));
      });
    }

    function showLeaf(key, clickedElement) {
      GlyphAnimator.stopStudyLoop();

      const formattedKey = String(key || "").replace(/(^|\s|-|_)\S/g, m => m.toUpperCase());
      nodeRoot.textContent = `└─ ${formattedKey}`;

      if (key === 'info') {
        nodeChildren.innerHTML = `
          <div class="item cascade" data-cascade="1" style="opacity: 0; transform: translateX(16px);">├─ Rights / Usage</div>
          <div class="item cascade" data-cascade="2" style="opacity: 0; transform: translateX(16px);">├─ Licensing</div>
          <div class="item cascade" data-cascade="3" style="opacity: 0; transform: translateX(16px);">└─ Acknowledgements</div>
        `;
      } else {
        nodeChildren.innerHTML = `
          <div class="item cascade" data-cascade="1" style="opacity: 0; transform: translateX(16px);">└─ Placeholder</div>
        `;
      }

      transitionToView(nodeView, clickedElement, () => {
        playCascade(nodeView);
      });
    }

    function showGallery() {
      if (isAnimating) return;
      isAnimating = true;

      GlyphAnimator.stopStudyLoop();
      DustEffect.clear();

      // Apply dustDissolve effect to content (not the back button)
      requestAnimationFrame(() => {
        const activeView = studyView.classList.contains("view--active") ? studyView : nodeView;
        const contentElements = activeView.querySelectorAll('.root, .children, .item');
        
        console.log('Found elements:', contentElements.length);
        contentElements.forEach(el => {
          console.log('Adding dust-out to:', el);
          el.classList.add('dust-out');
        });
      });

      setTimeout(() => {
        requestAnimationFrame(() => {
          document.body.classList.remove("study-triggered");
          studyView.classList.remove("view--active");
          nodeView.classList.remove("view--active");

          studyView.style.opacity = "";
          nodeView.style.opacity = "";

          galleryView.classList.add("view--active");
          galleryView.style.opacity = "0";
          galleryView.style.transition = `opacity ${TIMINGS.GALLERY_FADE_IN}ms ease`;

          requestAnimationFrame(() => {
            galleryView.style.opacity = "1";

            setTimeout(() => {
              galleryView.style.opacity = "";
              galleryView.style.transition = "";
              isAnimating = false; // Unlock after animation completes
            }, TIMINGS.GALLERY_FADE_IN);
          });

          logo.classList.remove("logo-blur");
          document.body.classList.remove("gallery-intro-cascade");
          GlyphAnimator.startGalleryLoop();
        });

        clearStudyInlineAnim();

        document.querySelectorAll('#galleryView .gallery-line').forEach(line => {
          line.style.animation = "";
          line.style.animationDelay = "";
        });
      }, 600);
    }

    // =========================================================================
    // BACK BUTTON HANDLER
    // =========================================================================
    function handleBackClick(e) {
      if (isAnimating) return;
      
      const btn = e.currentTarget;
      btn.classList.remove('flash');
      void btn.offsetWidth;
      btn.classList.add('flash');
      showGallery();
    }

    // =========================================================================
    // INITIALIZATION
    // =========================================================================
    syncTreeToLogo();
    addEventListener("resize", syncTreeToLogo);

    if (document.fonts && document.fonts.ready) {
      document.fonts.ready.then(() => syncTreeToLogo());
    }
    addEventListener("load", () => syncTreeToLogo());

    requestAnimationFrame(() => IntroCascade.run());

    requestAnimationFrame(() => {
      requestAnimationFrame(() => {
        GlyphAnimator.startGalleryLoop();
      });
    });

    studyButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        if (isAnimating) return;
        
        btn.classList.remove('flash');
        void btn.offsetWidth;
        btn.classList.add('flash');
        btn.addEventListener('animationend', () => btn.classList.remove('flash'), { once: true });
        
        applyZoomOriginFromEl(btn);
        showStudy(btn.dataset.study, btn);
      });
    });

    nodeButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        if (isAnimating) return;
        
        btn.classList.remove('flash');
        void btn.offsetWidth;
        btn.classList.add('flash');
        btn.addEventListener('animationend', () => btn.classList.remove('flash'), { once: true });
        
        applyZoomOriginFromEl(btn);
        showLeaf(btn.dataset.node, btn);
      });
    });

    backBtn.addEventListener("click", handleBackClick);
    nodeBackBtn.addEventListener("click", handleBackClick);
  </script>
</FrameLayout>