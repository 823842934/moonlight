---
import FrameLayout from "../layouts/FrameLayout.astro";
---

<FrameLayout title="Body of Work">
  <section class="hero">
    <div class="stack" id="stack">
      <h1 id="logo">brandyura</h1>

      <div class="tree" id="tree" aria-label="gallery tree">
        <div class="tree-viewport" id="viewport">
          <!-- GALLERY VIEW -->
          <div id="galleryView" class="view view--active">
            <div class="root gallery-line">Gallery</div>

            <div class="children">
              <button class="item item-btn gallery-line" type="button" data-study="study:[//000-00001]">├─ Study:[//000-00001]</button>
              <button class="item item-btn gallery-line" type="button" data-study="study:[//000-00002]">├─ Study:[//000-00002]</button>
              <button class="item item-btn gallery-line" type="button" data-study="study:[//000-00003]">├─ Study:[//000-00003]</button>
              <button class="item item-btn gallery-line" type="button" data-study="study:[//000-00004]">├─ Study:[//000-00004]</button>
              <button class="item item-btn gallery-line" type="button" data-study="study:[//000-00005]">├─ Study:[//000-00005]</button>
              <button class="item item-btn gallery-line" type="button" data-study="study:[//000-00006]">├─ Study:[//000-00006]</button>
              <button class="item item-btn gallery-line" type="button" data-study="study:[//000-00007]">├─ Study:[//000-00007]</button>
              <button class="item item-btn gallery-line" type="button" data-study="study:[//000-00008]">├─ Study:[//000-00008]</button>
              <button class="item item-btn gallery-line" type="button" data-study="study:[//000-00009]">├─ Study:[//000-00009]</button>
              <button class="item item-btn gallery-line" type="button" data-study="study:[//000-00010]">└─ Study:[//000-00010]</button>
            </div>

            <!-- NON-CLICKABLE PARENTS -->
            <div class="root gallery-line">About</div>
            <div class="children">
              <button class="item item-btn gallery-line" type="button" data-node="biography">├─ Biography</button>
              <button class="item item-btn gallery-line" type="button" data-node="statement">├─ Statement</button>
              <button class="item item-btn gallery-line" type="button" data-node="process">└─ Process</button>
            </div>

            <div class="root gallery-line">Contact</div>
            <div class="children">
              <button class="item item-btn gallery-line" type="button" data-node="hello">├─ Hello</button>
              <button class="item item-btn gallery-line" type="button" data-node="social">└─ Social</button>
            </div>

            <div class="root gallery-line">Legal</div>
            <div class="children">
              <button class="item item-btn gallery-line" type="button" data-node="placeholder">└─ Placeholder</button>
            </div>
          </div>

          <!-- STUDY VIEW -->
          <div id="studyView" class="view zoomed">
            <button id="backBtn" class="back" type="button">
              <span class="arrow">←</span><span class="label"> Back</span>
            </button>

            <div id="studyRoot" class="root">
              Study:[<span id="studyGlyph" class="glyph-slot">//</span><span id="studyId">000-00001</span>]
            </div>

            <div class="children children--indented">
              <div class="item cascade" data-cascade="1">├─ About</div>
              <div class="item cascade" data-cascade="2">├─ Purpose</div>
              <div class="item cascade" data-cascade="3">└─ Date</div>
            </div>
          </div>

          <!-- NODE VIEW -->
          <div id="nodeView" class="view zoomed">
            <button id="nodeBackBtn" class="back" type="button">
              <span class="arrow">←</span><span class="label"> Back</span>
            </button>

            <div id="nodeRoot" class="root" data-cascade="0"></div>
            <div class="children children--indented" id="nodeChildren"></div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <style>
    /* ===== MOBILE HORIZONTAL SCROLL FIX (GLOBAL FOR THIS PAGE) ===== */
    html, body {
      max-width: 100%;
      overflow-x: hidden;
      overscroll-behavior-x: none;
    }

    /* Safety clamp against transform/fit-content overflow */
    * {
      box-sizing: border-box;
      max-width: 100%;
    }

    .hero {
      min-height: 100dvh;

      padding-left: 5vw;
      padding-right: 5vw;

      /* START HIGHER: less top padding, still respects corner vars */
      padding-top: clamp(10px, 2.2vh, calc(var(--corner-inset, 22px) * 0.6 + var(--corner-size, 28px) * 0.6));
      padding-bottom: clamp(16px, 4vh, calc(var(--corner-inset, 22px) + var(--corner-size, 28px)));

      display: flex;
      justify-content: center;

      /* START HIGHER: align towards top, not centered */
      align-items: flex-start;

      /* horizontal overflow lock for this section */
      overflow-x: hidden;
    }

    .stack {
      width: min(1100px, 100%);
      box-sizing: border-box;

      /* START HIGHER: add only a tiny nudge instead of the old 6px */
      padding-top: 2px;
    }

    h1 {
      font-family: "ABC Diatype", system-ui, sans-serif;
      font-weight: 700;
      font-size: clamp(56px, 16vw, 260px);
      letter-spacing: -0.05em;
      line-height: 1;
      margin: 0;
      width: 100%;
      text-align: center;
      text-rendering: geometricPrecision;
      
      /* FIXED: Isolate logo from tree viewport transforms */
      position: relative;
      z-index: 10;
    }

    .logo-blur { filter: blur(6px); }

    #logo {
      transform: translateX(var(--logo-shift, 0px));
      transition:
        opacity 400ms cubic-bezier(.22,.61,.36,1),
        filter 400ms cubic-bezier(.22,.61,.36,1);
      will-change: opacity, filter;
    }
    body.study-triggered #logo {
      opacity: 0;
      filter: blur(10px);
      pointer-events: none;
    }

    .tree {
      margin-top: 0.5rem;
      font-family: "ABC Diatype", system-ui, sans-serif;
      font-size: clamp(14px, 3.5vw, 18px);
      letter-spacing: 0.02em;
      width: 100%;
      box-sizing: border-box;
      padding-left: var(--logo-left, 0px);
      
      /* FIXED: Isolate tree from logo */
      position: relative;
      z-index: 5;
    }

    .tree-viewport {
      position: relative;
      min-height: 12.5rem;
      width: 100%;
      max-width: 100%;
      overflow-x: hidden;
      overflow: visible;
      transform-origin: center left;
      transition: transform 500ms cubic-bezier(.4,0,.2,1);
      will-change: transform;
    }

    .tree-viewport.zoom-in {
      transform: scale(1.25) translateX(40px);
    }

    .root,
    .item,
    .item-btn,
    .back {
      white-space: nowrap;
      overflow-wrap: normal;
      word-break: normal;
      hyphens: none;
    }

    .root { margin: 0; }

    .children {
      margin-top: 0.35rem;
      display: grid;
      gap: 0.18rem;
      width: fit-content;
      margin-bottom: 0.55rem;
    }

    .children--indented {
      padding-left: 2ch;
      margin-bottom: 0;
    }

    .item {
      line-height: 1.25;
      width: fit-content;
    }

    .item-btn {
      background: none;
      border: 0;
      padding: 0;
      font: inherit;
      color: inherit;
      cursor: pointer;
      text-align: left;
      display: inline-block;
      width: fit-content;
    }

    .back {
      background: none;
      border: 0;
      padding: 0;
      font: inherit;
      color: inherit;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.15em;
      margin-bottom: 0.35rem;
    }

    .view {
      position: absolute;
      inset: 0;
      width: 100%;
      max-width: 100%;
      transition: opacity 260ms ease, transform 260ms ease;
    }

    .view:not(.view--active) {
      opacity: 0;
      pointer-events: none;
    }

    .view.view--active { opacity: 1; }

    .zoomed { transform: scale(1.15); }

    .cascade {
      opacity: 0;
      transform: translateX(16px);
      transition: opacity 260ms ease, transform 260ms ease;
    }
    .view--active .cascade {
      opacity: 1;
      transform: translateX(0);
    }
    .view--active .cascade[data-cascade="0"] { transition-delay: 0ms; }
    .view--active .cascade[data-cascade="1"] { transition-delay: 80ms; }
    .view--active .cascade[data-cascade="2"] { transition-delay: 160ms; }
    .view--active .cascade[data-cascade="3"] { transition-delay: 240ms; }

    .glyph-slot {
      display: inline-block;
      width: 2ch;
      text-align: center;
    }

    @keyframes galleryIntroCascade {
      from { opacity: 0; transform: translateY(-10px); filter: blur(1px); }
      to   { opacity: 1; transform: translateY(0);   filter: blur(0); }
    }

    .gallery-line { opacity: 1; }

    body.gallery-intro-cascade .gallery-line {
      opacity: 0;
      animation: galleryIntroCascade 420ms cubic-bezier(.25,.8,.25,1) forwards;
    }

    @media (prefers-reduced-motion: reduce) {
      body.gallery-intro-cascade .gallery-line {
        opacity: 1;
        animation: none !important;
        transform: none !important;
        filter: none !important;
      }
      #logo { transition: none !important; }
      .tree-viewport { transition: none !important; }
      .view { transition: none !important; }
    }

    @media (max-width: 520px) {
      html, body {
        overflow-x: hidden;
        touch-action: pan-y;
      }

      body {
        position: relative;
      }

      .hero {
        /* adjust this value to move everything up/down on mobile */
        padding-top: calc(22px + env(safe-area-inset-top, 0px));
        padding-bottom: 16px;
      }

      /* reduce transform push to prevent sideways "drift" */
      .tree-viewport.zoom-in {
        transform: scale(1.15) translateX(12px);
      }
    }
  </style>

  <script>
    const stack = document.getElementById("stack");
    const logo = document.getElementById("logo");

    const viewport = document.getElementById("viewport");
    const galleryView = document.getElementById("galleryView");
    const studyView = document.getElementById("studyView");
    const nodeView = document.getElementById("nodeView");

    const studyRoot = document.getElementById("studyRoot");
    const studyGlyph = document.getElementById("studyGlyph");
    const studyId = document.getElementById("studyId");

    const nodeRoot = document.getElementById("nodeRoot");
    const nodeChildren = document.getElementById("nodeChildren");

    const backBtn = document.getElementById("backBtn");
    const nodeBackBtn = document.getElementById("nodeBackBtn");

    const studyButtons = document.querySelectorAll("[data-study]");
    const nodeButtons = document.querySelectorAll("[data-node]");

    function centerLogoAcrossDevices() {
      const stackRect = stack.getBoundingClientRect();
      const logoRect = logo.getBoundingClientRect();

      const desiredLeft = (stackRect.width - logoRect.width) / 2;
      const currentLeft = logoRect.left - stackRect.left;
      const delta = desiredLeft - currentLeft;

      stack.style.setProperty("--logo-shift", `${delta}px`);
    }

    function syncTreeToLogo() {
      centerLogoAcrossDevices();

      const stackRect = stack.getBoundingClientRect();
      const logoRect = logo.getBoundingClientRect();
      const left = Math.max(0, logoRect.left - stackRect.left);
      stack.style.setProperty("--logo-left", `${left}px`);
    }

    let lastOrigin = null;

    function applyZoomOriginFromEl(el) {
      if (!el) return;

      const vpRect = viewport.getBoundingClientRect();
      const elRect = el.getBoundingClientRect();

      const x = Math.max(0, elRect.left - vpRect.left + 4);

      /* fixed vertical origin for consistent height */
      const y = vpRect.height * 0.5;

      lastOrigin = { x, y };

      const originStr = `${x}px ${y}px`;
      viewport.style.transformOrigin = originStr;
      studyView.style.transformOrigin = originStr;
      nodeView.style.transformOrigin = originStr;
    }

    function clearZoomOriginAfterOut() {
      window.setTimeout(() => {
        viewport.style.transformOrigin = "";
        studyView.style.transformOrigin = "";
        nodeView.style.transformOrigin = "";
        lastOrigin = null;
      }, 520);
    }

    let galleryCascadeHasRun = false;

    function runGalleryIntroCascadeOnce() {
      if (galleryCascadeHasRun) return;
      galleryCascadeHasRun = true;

      const lines = Array.from(document.querySelectorAll("#galleryView .gallery-line"));
      if (!lines.length) return;

      document.body.classList.add("gallery-intro-cascade");

      const stagger = 80;
      lines.forEach((el, i) => { el.style.animationDelay = `${i * stagger}ms`; });

      const ms = 420;
      const total = ms + (lines.length - 1) * stagger + 60;

      setTimeout(() => {
        document.body.classList.remove("gallery-intro-cascade");
        lines.forEach((el) => {
          el.style.animationDelay = "";
          el.style.opacity = "";
          el.style.transform = "";
          el.style.filter = "";
          el.style.animation = "";
        });
      }, total);
    }

    const GLYPHS = ["//", "--", "\\\\", "| |"];
    const GLYPH_MS = 110;
    let glyphTimer = null;
    let glyphIndex = 0;

    function startGlyphLoop() {
      if (glyphTimer) return;
      glyphIndex = 0;
      studyGlyph.textContent = "//";

      glyphTimer = setInterval(() => {
        glyphIndex = (glyphIndex + 1) % GLYPHS.length;
        studyGlyph.textContent = GLYPHS[glyphIndex];
      }, GLYPH_MS);
    }

    function stopGlyphLoop() {
      if (glyphTimer) {
        clearInterval(glyphTimer);
        glyphTimer = null;
      }
      glyphIndex = 0;
      studyGlyph.textContent = "//";
    }

    function parseStudyFixed(str) {
      const m = String(str || "").match(/^study:\[(\/\/|--|\\\\|\|\s\|)([0-9]{3}-[0-9]{5})\]$/i);
      if (!m) return null;
      return { glyph: m[1], id: m[2] };
    }

    function playCascade(containerEl) {
      if (!containerEl) return;
      if (window.matchMedia && window.matchMedia("(prefers-reduced-motion: reduce)").matches) return;

      const els = Array.from(containerEl.querySelectorAll("[data-cascade]"))
        .filter((el) => el instanceof HTMLElement)
        .sort((a, b) => (Number(a.dataset.cascade) || 0) - (Number(b.dataset.cascade) || 0));

      if (!els.length) return;

      els.forEach((el) => {
        const n = Number(el.dataset.cascade) || 0;
        el.style.transitionProperty = "opacity, transform";
        el.style.transitionDuration = "260ms";
        el.style.transitionTimingFunction = "ease";
        el.style.transitionDelay = `${n * 80}ms`;
        el.style.opacity = "0";
        el.style.transform = "translateX(16px)";
      });

      void containerEl.offsetWidth;

      requestAnimationFrame(() => {
        els.forEach((el) => {
          el.style.opacity = "1";
          el.style.transform = "translateX(0)";
        });
      });
    }

    function showStudy(name) {
      const parsed = parseStudyFixed(name);
      if (parsed) {
        studyGlyph.textContent = "//";
        studyId.textContent = parsed.id;
      } else {
        studyRoot.textContent = name;
      }

      document.body.classList.add("study-triggered");

      nodeView.classList.remove("view--active");
      galleryView.classList.remove("view--active");
      studyView.classList.add("view--active");

      viewport.classList.add("zoom-in");
      logo.classList.add("logo-blur");

      requestAnimationFrame(() => requestAnimationFrame(startGlyphLoop));
    }

    function showLeaf(key) {
      stopGlyphLoop();

      document.body.classList.add("study-triggered");

      nodeRoot.textContent = String(key || "").replace(/(^|\s|-|_)\S/g, (m) => m.toUpperCase());
      nodeRoot.setAttribute("data-cascade", "0");

      nodeChildren.innerHTML = `<div class="item" data-cascade="1">└─ Placeholder</div>`;

      studyView.classList.remove("view--active");
      galleryView.classList.remove("view--active");
      nodeView.classList.add("view--active");

      viewport.classList.add("zoom-in");
      logo.classList.add("logo-blur");

      playCascade(nodeView);
    }

    function clearStudyInlineAnim() {
      const studyLines = Array.from(document.querySelectorAll('#galleryView [data-study].gallery-line'));
      studyLines.forEach((el) => {
        el.style.animation = "";
        el.style.animationDelay = "";
        el.style.opacity = "";
        el.style.transform = "";
        el.style.filter = "";
      });
    }

    function showGallery() {
      stopGlyphLoop();

      document.body.classList.remove("study-triggered");

      studyView.classList.remove("view--active");
      nodeView.classList.remove("view--active");
      galleryView.classList.add("view--active");

      viewport.classList.remove("zoom-in");
      logo.classList.remove("logo-blur");

      document.body.classList.remove("gallery-intro-cascade");
      clearStudyInlineAnim();

      if (lastOrigin) clearZoomOriginAfterOut();
    }

    syncTreeToLogo();
    addEventListener("resize", syncTreeToLogo);

    if (document.fonts && document.fonts.ready) {
      document.fonts.ready.then(() => syncTreeToLogo());
    }
    addEventListener("load", () => syncTreeToLogo());

    requestAnimationFrame(runGalleryIntroCascadeOnce);

    studyButtons.forEach((btn) => {
      btn.addEventListener("click", () => {
        applyZoomOriginFromEl(btn);
        showStudy(btn.dataset.study);
      });
    });

    nodeButtons.forEach((btn) => {
      btn.addEventListener("click", () => {
        applyZoomOriginFromEl(btn);
        showLeaf(btn.dataset.node);
      });
    });

    backBtn.addEventListener("click", showGallery);
    nodeBackBtn.addEventListener("click", showGallery);
  </script>
</FrameLayout>
